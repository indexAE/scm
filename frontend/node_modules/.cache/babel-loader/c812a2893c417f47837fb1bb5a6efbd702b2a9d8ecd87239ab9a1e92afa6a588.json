{"ast":null,"code":"import _regeneratorRuntime from \"C:/Users/indexae/Desktop/scm\\u9000\\u8D27/scm/frontend/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"C:/Users/indexae/Desktop/scm\\u9000\\u8D27/scm/frontend/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.array.includes.js\";\nimport \"core-js/modules/es.array.some.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/esnext.iterator.constructor.js\";\nimport \"core-js/modules/esnext.iterator.some.js\";\nimport { createRouter, createWebHashHistory } from 'vue-router';\nimport { usePermissionStore } from '@/stores/permission';\nimport { ElMessage } from 'element-plus';\nimport routes from './routes';\nvar router = createRouter({\n  history: createWebHashHistory(),\n  routes: routes\n});\n\n// 白名单路由\nvar whiteList = ['/login', '/register', '/403'];\nrouter.beforeEach(/*#__PURE__*/function () {\n  var _ref = _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime().mark(function _callee(to, from, next) {\n    var token, permissionStore;\n    return _regeneratorRuntime().wrap(function _callee$(_context) {\n      while (1) switch (_context.prev = _context.next) {\n        case 0:\n          // 获取token\n          token = localStorage.getItem('token');\n          permissionStore = usePermissionStore(); // 白名单路由直接放行\n          if (!whiteList.includes(to.path)) {\n            _context.next = 5;\n            break;\n          }\n          next();\n          return _context.abrupt(\"return\");\n        case 5:\n          if (!token) {\n            _context.next = 27;\n            break;\n          }\n          if (!(to.path === '/login')) {\n            _context.next = 10;\n            break;\n          }\n          // 已登录且要跳转的页面是登录页\n          next({\n            path: '/dashboard'\n          });\n          _context.next = 25;\n          break;\n        case 10:\n          if (!(permissionStore.roles.length === 0)) {\n            _context.next = 24;\n            break;\n          }\n          _context.prev = 11;\n          _context.next = 14;\n          return permissionStore.fetchUserPermissions();\n        case 14:\n          // 判断是否有权限访问该路由\n          if (hasPermission(to, permissionStore)) {\n            next();\n          } else {\n            next({\n              path: '/403'\n            });\n          }\n          _context.next = 22;\n          break;\n        case 17:\n          _context.prev = 17;\n          _context.t0 = _context[\"catch\"](11);\n          // 拉取用户信息失败，可能是token过期\n          localStorage.removeItem('token');\n          ElMessage.error('登录状态已过期，请重新登录');\n          next(\"/login?redirect=\".concat(to.path));\n        case 22:\n          _context.next = 25;\n          break;\n        case 24:\n          // 已有用户信息，判断是否有权限访问该路由\n          if (hasPermission(to, permissionStore)) {\n            next();\n          } else {\n            next({\n              path: '/403'\n            });\n          }\n        case 25:\n          _context.next = 28;\n          break;\n        case 27:\n          // 没有token\n          next(\"/login?redirect=\".concat(to.path));\n        case 28:\n        case \"end\":\n          return _context.stop();\n      }\n    }, _callee, null, [[11, 17]]);\n  }));\n  return function (_x, _x2, _x3) {\n    return _ref.apply(this, arguments);\n  };\n}());\n\n// 判断是否有权限访问该路由\nfunction hasPermission(route, store) {\n  if (route.meta && route.meta.roles) {\n    // 如果是管理员，可以访问所有页面\n    if (store.isAdmin) {\n      return true;\n    }\n    // 判断是否有该角色\n    return route.meta.roles.some(function (role) {\n      return store.hasRole(role);\n    });\n  }\n  return true;\n}\nexport default router;","map":{"version":3,"names":["createRouter","createWebHashHistory","usePermissionStore","ElMessage","routes","router","history","whiteList","beforeEach","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","to","from","next","token","permissionStore","wrap","_callee$","_context","prev","localStorage","getItem","includes","path","abrupt","roles","length","fetchUserPermissions","hasPermission","t0","removeItem","error","concat","stop","_x","_x2","_x3","apply","arguments","route","store","meta","isAdmin","some","role","hasRole"],"sources":["C:/Users/indexae/Desktop/scm退货/scm/frontend/src/router/index.js"],"sourcesContent":["import { createRouter, createWebHashHistory } from 'vue-router'\nimport { usePermissionStore } from '@/stores/permission'\nimport { ElMessage } from 'element-plus'\nimport routes from './routes'\n\nconst router = createRouter({\n  history: createWebHashHistory(),\n  routes\n})\n\n// 白名单路由\nconst whiteList = ['/login', '/register', '/403']\n\nrouter.beforeEach(async (to, from, next) => {\n  // 获取token\n  const token = localStorage.getItem('token')\n  const permissionStore = usePermissionStore()\n\n  // 白名单路由直接放行\n  if (whiteList.includes(to.path)) {\n    next()\n    return\n  }\n\n  if (token) {\n    if (to.path === '/login') {\n      // 已登录且要跳转的页面是登录页\n      next({ path: '/dashboard' })\n    } else {\n      // 判断当前用户是否已拉取完user_info信息\n      if (permissionStore.roles.length === 0) {\n        try {\n          // 拉取用户信息\n          await permissionStore.fetchUserPermissions()\n          \n          // 判断是否有权限访问该路由\n          if (hasPermission(to, permissionStore)) {\n            next()\n          } else {\n            next({ path: '/403' })\n          }\n        } catch (error) {\n          // 拉取用户信息失败，可能是token过期\n          localStorage.removeItem('token')\n          ElMessage.error('登录状态已过期，请重新登录')\n          next(`/login?redirect=${to.path}`)\n        }\n      } else {\n        // 已有用户信息，判断是否有权限访问该路由\n        if (hasPermission(to, permissionStore)) {\n          next()\n        } else {\n          next({ path: '/403' })\n        }\n      }\n    }\n  } else {\n    // 没有token\n    next(`/login?redirect=${to.path}`)\n  }\n})\n\n// 判断是否有权限访问该路由\nfunction hasPermission(route, store) {\n  if (route.meta && route.meta.roles) {\n    // 如果是管理员，可以访问所有页面\n    if (store.isAdmin) {\n      return true\n    }\n    // 判断是否有该角色\n    return route.meta.roles.some(role => store.hasRole(role))\n  }\n  return true\n}\n\nexport default router "],"mappings":";;;;;;;AAAA,SAASA,YAAY,EAAEC,oBAAoB,QAAQ,YAAY;AAC/D,SAASC,kBAAkB,QAAQ,qBAAqB;AACxD,SAASC,SAAS,QAAQ,cAAc;AACxC,OAAOC,MAAM,MAAM,UAAU;AAE7B,IAAMC,MAAM,GAAGL,YAAY,CAAC;EAC1BM,OAAO,EAAEL,oBAAoB,CAAC,CAAC;EAC/BG,MAAM,EAANA;AACF,CAAC,CAAC;;AAEF;AACA,IAAMG,SAAS,GAAG,CAAC,QAAQ,EAAE,WAAW,EAAE,MAAM,CAAC;AAEjDF,MAAM,CAACG,UAAU;EAAA,IAAAC,IAAA,GAAAC,iBAAA,cAAAC,mBAAA,GAAAC,IAAA,CAAC,SAAAC,QAAOC,EAAE,EAAEC,IAAI,EAAEC,IAAI;IAAA,IAAAC,KAAA,EAAAC,eAAA;IAAA,OAAAP,mBAAA,GAAAQ,IAAA,UAAAC,SAAAC,QAAA;MAAA,kBAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAL,IAAA;QAAA;UACrC;UACMC,KAAK,GAAGM,YAAY,CAACC,OAAO,CAAC,OAAO,CAAC;UACrCN,eAAe,GAAGhB,kBAAkB,CAAC,CAAC,EAE5C;UAAA,KACIK,SAAS,CAACkB,QAAQ,CAACX,EAAE,CAACY,IAAI,CAAC;YAAAL,QAAA,CAAAL,IAAA;YAAA;UAAA;UAC7BA,IAAI,CAAC,CAAC;UAAA,OAAAK,QAAA,CAAAM,MAAA;QAAA;UAAA,KAIJV,KAAK;YAAAI,QAAA,CAAAL,IAAA;YAAA;UAAA;UAAA,MACHF,EAAE,CAACY,IAAI,KAAK,QAAQ;YAAAL,QAAA,CAAAL,IAAA;YAAA;UAAA;UACtB;UACAA,IAAI,CAAC;YAAEU,IAAI,EAAE;UAAa,CAAC,CAAC;UAAAL,QAAA,CAAAL,IAAA;UAAA;QAAA;UAAA,MAGxBE,eAAe,CAACU,KAAK,CAACC,MAAM,KAAK,CAAC;YAAAR,QAAA,CAAAL,IAAA;YAAA;UAAA;UAAAK,QAAA,CAAAC,IAAA;UAAAD,QAAA,CAAAL,IAAA;UAAA,OAG5BE,eAAe,CAACY,oBAAoB,CAAC,CAAC;QAAA;UAE5C;UACA,IAAIC,aAAa,CAACjB,EAAE,EAAEI,eAAe,CAAC,EAAE;YACtCF,IAAI,CAAC,CAAC;UACR,CAAC,MAAM;YACLA,IAAI,CAAC;cAAEU,IAAI,EAAE;YAAO,CAAC,CAAC;UACxB;UAACL,QAAA,CAAAL,IAAA;UAAA;QAAA;UAAAK,QAAA,CAAAC,IAAA;UAAAD,QAAA,CAAAW,EAAA,GAAAX,QAAA;UAED;UACAE,YAAY,CAACU,UAAU,CAAC,OAAO,CAAC;UAChC9B,SAAS,CAAC+B,KAAK,CAAC,eAAe,CAAC;UAChClB,IAAI,oBAAAmB,MAAA,CAAoBrB,EAAE,CAACY,IAAI,CAAE,CAAC;QAAA;UAAAL,QAAA,CAAAL,IAAA;UAAA;QAAA;UAGpC;UACA,IAAIe,aAAa,CAACjB,EAAE,EAAEI,eAAe,CAAC,EAAE;YACtCF,IAAI,CAAC,CAAC;UACR,CAAC,MAAM;YACLA,IAAI,CAAC;cAAEU,IAAI,EAAE;YAAO,CAAC,CAAC;UACxB;QAAC;UAAAL,QAAA,CAAAL,IAAA;UAAA;QAAA;UAIL;UACAA,IAAI,oBAAAmB,MAAA,CAAoBrB,EAAE,CAACY,IAAI,CAAE,CAAC;QAAA;QAAA;UAAA,OAAAL,QAAA,CAAAe,IAAA;MAAA;IAAA,GAAAvB,OAAA;EAAA,CAErC;EAAA,iBAAAwB,EAAA,EAAAC,GAAA,EAAAC,GAAA;IAAA,OAAA9B,IAAA,CAAA+B,KAAA,OAAAC,SAAA;EAAA;AAAA,IAAC;;AAEF;AACA,SAASV,aAAaA,CAACW,KAAK,EAAEC,KAAK,EAAE;EACnC,IAAID,KAAK,CAACE,IAAI,IAAIF,KAAK,CAACE,IAAI,CAAChB,KAAK,EAAE;IAClC;IACA,IAAIe,KAAK,CAACE,OAAO,EAAE;MACjB,OAAO,IAAI;IACb;IACA;IACA,OAAOH,KAAK,CAACE,IAAI,CAAChB,KAAK,CAACkB,IAAI,CAAC,UAAAC,IAAI;MAAA,OAAIJ,KAAK,CAACK,OAAO,CAACD,IAAI,CAAC;IAAA,EAAC;EAC3D;EACA,OAAO,IAAI;AACb;AAEA,eAAe1C,MAAM","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}